<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>GetAll</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    </head>
    <body>

        <div class="container">

            <div class="row mt-5">

                <div class="col-12 col-sm-6">
                    <p class="h2 text-primary"><strong>Usuario</strong></p>
                </div>

                <div class="col-12 col-sm-6 col-lg-6 d-sm-flex justify-content-sm-end gap-2">
                    <a type="button" class="btn btn-success" th:href="@{/usuario/form}"><i class="bi bi-plus-lg"></i> Agregar</a>
                    <a type="button" class="btn btn-primary" th:href="@{/usuario/cargamasiva}"><i class="bi bi-arrow-bar-down"></i> Cargar datos</a>
                </div>


            </div>

            <div class="card shadow-sm mt-4">
                <div class="card-body">

                    <form th:action="@{/usuario/getAll}" method="get">

                        <div class="row g-3">

                            <div class="col-md-3">
                                <label class="form-label">Nombre</label>
                                <input type="text" 
                                       placeholder="Nombre"
                                       name="nombre"
                                       class="form-control"
                                       th:value="${param.nombre}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Apellido Paterno</label>
                                <input type="text" 
                                       placeholder="Apellido Paterno"
                                       name="apellidoPaterno"
                                       class="form-control"
                                       th:value="${param.apellidoPaterno}">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Apellido Materno</label>
                                <input type="text" 
                                       placeholder="Apellido Materno"
                                       name="apellidoMaterno"
                                       class="form-control"
                                       th:value="${param.apellidoMaterno}">
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Rol</label>
                                <select name="idRol" class="form-select">
                                    <option value="0">Todos</option>
                                    <option th:each="rol : ${roles}"
                                            th:value="${rol.idRol}"
                                            th:text="${rol.nombreRol}"
                                            th:selected="${param.idRol == rol.idRol}">
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>

                        </div>

                    </form>

                </div>
            </div>


            <div class="table-responsive mt-5">

                <table class="table table-hover align-middle shadow-sm">
                    <thead class="table-dark text-center">
                        <tr>
                            <th style="width:120px;">Foto</th>
                            <th>Información Personal</th>
                            <th>Contacto</th>
                            <th>Dirección</th>
                            <th style="width:120px;">Acciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="usuario : ${usuarios}">

                            <!-- IMAGEN -->
                            <td class="text-center">
                                <img th:if="${usuario.imagen != null}"
                                     th:src="'data:image/jpeg;base64,' + ${usuario.imagen}"
                                     class="rounded-circle border"
                                     style="width:80px; height:80px; object-fit:cover;" />

                                <img th:if="${usuario.imagen == null}"
                                     src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
                                     class="rounded-circle border"
                                     style="width:80px; height:80px; object-fit:cover;" />
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="flexSwitchCheckChecked" checked>
                                    <label class="form-check-label" for="flexSwitchCheckChecked">Status</label>
                                </div>
                            </td>

                            <!-- INFORMACION PERSONAL -->
                            <td>
                                <h6 class="mb-1 fw-bold text-primary"
                                    th:text="${usuario.nombre} + ' ' + ${usuario.apellidoPaterno} + ' ' + ${usuario.apellidoMaterno}">
                                </h6>

                                <span class="badge bg-secondary"
                                      th:text="${usuario.userName}">
                                </span>

                                <div class="mt-2 small text-muted">
                                    <div><strong>CURP:</strong> <span th:text="${usuario?.CURP ?: 'NO REGISTRADO'}"></span></div>
                                    <div><strong>Fecha:</strong> <span th:text="${usuario.fechaNacimiento}"></span></div>
                                    <div><strong>Sexo:</strong> <span th:text="${usuario.sexo}"></span></div>
                                    <div><strong>Rol:</strong> 
                                        <span class="badge bg-info text-dark"
                                              th:text="${usuario.rol.nombreRol}">
                                        </span>
                                    </div>
                                </div>
                            </td>

                            <!-- CONTACTO -->
                            <td class="small">
                                <div><i class="bi bi-envelope"></i> 
                                    <span th:text="${usuario.email}"></span>
                                </div>
                                <div><i class="bi bi-telephone"></i> 
                                    <span th:text="${usuario.telefono}"></span>
                                </div>
                                <div><i class="bi bi-phone"></i> 
                                    <span th:text="${usuario.celular}"></span>
                                </div>
                            </td>

                            <!-- DIRECCION -->
                            <td class="small">

                                <!-- SI TIENE DIRECCIONES -->
                                <ul class="mb-0 ps-3"
                                    th:if="${usuario.direcciones != null and !#lists.isEmpty(usuario.direcciones)}"
                                    th:each="dir : ${usuario.direcciones}">
                                    <li>
                                        <span th:text="
                                              ${dir.calle} + ' #' + ${dir.numeroExterior} +
                                              (${dir.numeroInterior} != null ? ' Int. ' + ${dir.numeroInterior} : '') +
                                              ', ' + ${dir.colonia?.nombreColonia ?: 'Sin Colonia'} +
                                              ', ' + ${dir.colonia?.municipio?.nombreMunicipio ?: ''} +
                                              ', ' + ${dir.colonia?.municipio?.estado?.nombreEstado ?: ''}
                                              ">
                                        </span>
                                    </li>
                                </ul>

                                <!-- SI NO TIENE DIRECCION -->
                                <span class="text-muted fst-italic"
                                      th:if="${usuario.direcciones == null or #lists.isEmpty(usuario.direcciones)}">
                                    Dirección no registrada
                                </span>

                            </td>


                            <!-- ACCIONES -->
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <a class="btn btn-sm btn-success"
                                       th:href="@{/usuario/perfil/{id}(id=${usuario.idUsuario})}">
                                        <i class="bi bi-eye"></i>
                                    </a>

                                    <form th:action="@{/usuario/delete/{id}(id=${usuario.idUsuario})}"
                                          method="post"
                                          class="d-inline"
                                          onsubmit="return confirmDelete(event)">

                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>

                                    </form>

                                </div>
                            </td>

                        </tr>
                    </tbody>

                </table>

            </div>


        </div>

    </body>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
                                              function confirmDelete(event) {
                                                  event.preventDefault();

                                                  Swal.fire({
                                                      title: '¿Estás seguro?',
                                                      text: 'Esta acción eliminará el usuario y todas sus direcciones.',
                                                      icon: 'warning',
                                                      showCancelButton: true,
                                                      confirmButtonText: 'Sí, eliminar',
                                                      cancelButtonText: 'Cancelar'
                                                  }).then((result) => {
                                                      if (result.isConfirmed) {
                                                          event.target.submit();
                                                      }
                                                  });

                                                  return false;
                                              }



    </script>

    <script th:if="${icon != null}">
        Swal.fire({
            icon: '[[${icon}]]',
            title: '[[${title}]]',
            text: '[[${text}]]'
        });
    </script>



</html>
