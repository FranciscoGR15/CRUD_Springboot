
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"><!-- comment -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body>
        <br><br>
        <div class="container">

            <div class="text-center mb-4">
                <button id="mostrarFormulario" class="btn btn-primary btn-lg" onclick="mostrarFormulario()">
                    Seleccionar Tipo de Archivo
                </button>
            </div>


            <div id="botones" class="row justify-content-center mb-4" style="display:none">
                <div class="col-md-3 mb-2">
                    <button class="btn btn-success btn-block btn-lg" id="btnExcel">
                        <i class="bi bi-filetype-xlsx"></i> Excel
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-primary btn-block btn-lg " id="btnTxt">
                        <i class="bi bi-filetype-txt"></i>TXT
                    </button>
                </div>
            </div>


            <div id="formularioArchivo" class="card p-4 shadow" style="display: none; max-width: 500px; margin:auto;">
                <h5 class="card-title mb-3 text-center">Subir Archivo</h5>
                <form action="/usuario/cargamasiva" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" id="archivo" name="archivo" class="form-control" accept=".xlsx,.txt">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success" id="cargaMasiva">Subir Archivo</button>
                    </div>
                    <p class="mt-2 text-muted text-center">
                        Asegúrese de subir un archivo válido según la opción seleccionada.
                    </p>
                </form>
            </div>
        </div>

        <script>
            function mostrarFormulario() {
                document.getElementById("mostrarFormulario").style.display = "none";
                document.getElementById("botones").style.display = "flex";
            }

            let tipoArchivo = "";

            document.getElementById("btnExcel").addEventListener("click", function () {
                tipoArchivo = "xlsx";
                document.getElementById("formularioArchivo").style.display = "block";
                document.getElementById("archivo").setAttribute("accept", ".xlsx");
                document.getElementById("cargaMasiva").classList.remove("btn-primary");
                document.getElementById("cargaMasiva").classList.add("btn-success");
            });

            document.getElementById("btnTxt").addEventListener("click", function () {
                tipoArchivo = "txt";
                document.getElementById("formularioArchivo").style.display = "block";
                document.getElementById("archivo").setAttribute("accept", ".txt");
                document.getElementById("cargaMasiva").classList.remove("btn-success");
                document.getElementById("cargaMasiva").classList.add("btn-primary");
            });

            document.getElementById("archivo").addEventListener("change", function () {
                if (this.files.length > 0) {
                    var fileName = this.files[0].name;
                    var fileExtension = fileName.split('.').pop().toLowerCase();
                    if (fileExtension !== tipoArchivo) {
                        alert("Por favor, seleccione un archivo " + tipoArchivo.toUpperCase() + " válido.");
                        this.value = "";
                    }
                }
            });
        </script>

        <script th:inline="javascript">
            /*<![CDATA[*/

            document.addEventListener("DOMContentLoaded", function () {

                let icon = [[${icon}]];
                let title = [[${title}]];
                let text = [[${text}]];
                let errores = [[${errores}]];
                let mostrarProcesar = [[${mostrarProcesar}]];
                let uuidCarga = /*[[${uuidCarga}]]*/ null;

                console.log(icon);
                console.log(errores);

                if (icon === 'error') {

                    if (errores && errores.length > 0) {

                        let listaErrores = "";

                        errores.forEach(e => {
                            listaErrores += "Fila: " + e.fila +
                                    " | Campo: " + e.dato +
                                    " | Error: " + e.descripcion + "<br>";
                        });

                        Swal.fire({
                            icon: 'error',
                            title: title,
                            html: listaErrores
                        });

                    } else {

                        Swal.fire({
                            icon: 'error',
                            title: title,
                            text: text
                        });

                    }

                } else if (icon === 'success' && uuidCarga && uuidCarga !== 'null') {

                    Swal.fire({
                        icon: 'success',
                        title: title,
                        text: text,
                        showCancelButton: true,
                        confirmButtonText: 'Procesar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/usuario/cargamasiva/procesar/' + uuidCarga;
                        }
                    });
                }


            });

            /*]]>*/
        </script>
</html>